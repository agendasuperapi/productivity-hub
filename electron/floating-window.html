<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GerenciaZap</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: hsl(180, 100%, 2%);
    }
    
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: hsl(180, 100%, 6%);
      border-bottom: 1px solid hsl(180, 100%, 12%);
      -webkit-app-region: drag;
      transition: all 0.2s ease;
    }
    
    #toolbar.collapsed {
      padding: 4px 10px;
    }
    
    #toolbar.collapsed .nav-controls,
    #toolbar.collapsed .address-section,
    #toolbar.collapsed .zoom-control {
      display: none;
    }
    
    #toolbar.collapsed .separator {
      display: none;
    }
    
    #toolbar button,
    #toolbar input,
    #tab-name,
    .window-controls {
      -webkit-app-region: no-drag;
    }
    
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .address-section {
      flex: 1;
      display: flex;
    }
    
    #tab-name {
      font-size: 13px;
      font-weight: 500;
      color: hsl(180, 100%, 80%);
      padding: 0 8px;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .separator {
      width: 1px;
      height: 20px;
      background: hsl(180, 100%, 20%);
      margin: 0 4px;
    }
    
    .nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: hsl(180, 100%, 12%);
      color: hsl(180, 100%, 70%);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 14px;
    }
    
    .nav-btn:hover {
      background: hsl(180, 100%, 18%);
      color: hsl(180, 100%, 90%);
    }
    
    .nav-btn:active {
      background: hsl(180, 100%, 22%);
    }
    
    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    #address-bar {
      flex: 1;
      height: 28px;
      padding: 0 12px;
      border: 1px solid hsl(180, 100%, 20%);
      border-radius: 14px;
      background: hsl(180, 100%, 4%);
      color: hsl(180, 100%, 60%);
      font-size: 12px;
      outline: none;
      transition: border-color 0.15s ease;
    }
    
    #address-bar:focus {
      border-color: hsl(180, 100%, 32%);
      color: hsl(180, 100%, 80%);
    }
    
    .zoom-control {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 8px;
      border-left: 1px solid hsl(180, 100%, 20%);
      margin-left: 4px;
    }
    
    #zoom-value {
      font-size: 11px;
      color: hsl(180, 100%, 50%);
      min-width: 36px;
      text-align: center;
    }
    
    /* Window Controls */
    .window-controls {
      display: flex;
      align-items: center;
      margin-left: 8px;
      border-left: 1px solid hsl(180, 100%, 20%);
      padding-left: 8px;
    }
    
    .window-btn {
      width: 36px;
      height: 28px;
      border: none;
      background: transparent;
      color: hsl(180, 100%, 70%);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 14px;
    }
    
    .window-btn:hover {
      background: hsl(180, 100%, 15%);
      color: hsl(180, 100%, 90%);
    }
    
    .window-btn.close:hover {
      background: hsl(0, 70%, 50%);
      color: white;
    }
    
    .window-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .window-btn.maximize svg {
      width: 10px;
      height: 10px;
    }
    
    #webview {
      flex: 1;
      border: none;
      background: #fff;
    }
    
    /* Loading state */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: hsl(180, 100%, 50%);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid hsl(180, 100%, 20%);
      border-top-color: hsl(180, 100%, 50%);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #loading.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="toolbar">
      <button class="nav-btn" id="btn-toggle-toolbar" title="Ocultar/Mostrar barra">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
          <path d="M18 15l-6-6-6 6"/>
        </svg>
      </button>
      <span id="tab-name">Carregando...</span>
      <div class="separator"></div>
      <div class="nav-controls">
        <button class="nav-btn" id="btn-back" title="Voltar" disabled>&#8592;</button>
        <button class="nav-btn" id="btn-forward" title="Avançar" disabled>&#8594;</button>
        <button class="nav-btn" id="btn-reload" title="Recarregar">&#8635;</button>
      </div>
      
      <div class="address-section">
        <input type="text" id="address-bar" placeholder="Digite a URL e pressione Enter" spellcheck="false" />
      </div>
      
      <div class="zoom-control">
        <button class="nav-btn" id="btn-zoom-out" title="Diminuir zoom">&#8722;</button>
        <span id="zoom-value">100%</span>
        <button class="nav-btn" id="btn-zoom-in" title="Aumentar zoom">&#43;</button>
        <button class="nav-btn" id="btn-zoom-reset" title="Resetar zoom">&#9675;</button>
        <button class="nav-btn" id="btn-download" title="Abrir no navegador">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6M12 3v12M7 10l5 5 5-5"/>
          </svg>
        </button>
      </div>
      
      <div class="window-controls">
        <button class="window-btn" id="btn-minimize" title="Minimizar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14" />
          </svg>
        </button>
        <button class="window-btn maximize" id="btn-maximize" title="Maximizar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" />
          </svg>
        </button>
        <button class="window-btn close" id="btn-close" title="Fechar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
    
    <div id="loading">
      <div class="spinner"></div>
      <span>Carregando página...</span>
    </div>
    
    <webview id="webview" allowpopups></webview>
  </div>
  
  <script>
    // Variáveis para armazenar config pendente
    let pendingConfig = null;
    let currentZoom = 100;
    let initialZoom = 100;
    let shortcutScript = '';
    let isInitialized = false;
    let initialLoadComplete = false; // Flag para controlar loading inicial
    let isMaximized = false;
    let webviewReady = false; // Flag para saber se webview já carregou
    let toolbarCollapsed = false; // Flag para toolbar colapsada
    
    // SVG icons for maximize/restore and toggle
    const maximizeIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" /></svg>';
    const restoreIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="3" width="12" height="12" rx="1" /><path d="M3 9v9a2 2 0 002 2h9" /></svg>';
    const chevronUpIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M18 15l-6-6-6 6"/></svg>';
    const chevronDownIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M6 9l6 6 6-6"/></svg>';
    
    // Registrar listener IMEDIATAMENTE antes de qualquer outra coisa
    console.log('[FloatingWindow] Registering onInit listener immediately');
    window.floatingAPI.onInit((config) => {
      console.log('[FloatingWindow] Received config:', config);
      pendingConfig = config;
      applyConfig();
    });
    
    // Listener para mudanças de maximização
    window.floatingAPI.onMaximizeChange((maximized) => {
      isMaximized = maximized;
      updateMaximizeButton();
    });
    
    // Verificar estado inicial de maximização
    window.floatingAPI.isMaximized().then((maximized) => {
      isMaximized = maximized;
      updateMaximizeButton();
    });
    
    function updateMaximizeButton() {
      const btnMaximize = document.getElementById('btn-maximize');
      if (btnMaximize) {
        btnMaximize.innerHTML = isMaximized ? restoreIcon : maximizeIcon;
        btnMaximize.title = isMaximized ? 'Restaurar' : 'Maximizar';
      }
    }
    
    // Função para aplicar a configuração
    function applyConfig() {
      if (!pendingConfig || isInitialized) return;
      
      const webview = document.getElementById('webview');
      const addressBar = document.getElementById('address-bar');
      const tabName = document.getElementById('tab-name');
      
      // Verificar se os elementos existem
      if (!webview || !addressBar || !tabName) {
        console.log('[FloatingWindow] DOM not ready, waiting...');
        setTimeout(applyConfig, 50);
        return;
      }
      
      console.log('[FloatingWindow] Applying config:', pendingConfig);
      isInitialized = true;
      
      const config = pendingConfig;
      
      // Definir nome da aba
      if (config.name) {
        tabName.textContent = config.name;
        document.title = config.name + ' - GerenciaZap';
      }
      
      // Definir zoom inicial
      initialZoom = config.zoom || 100;
      currentZoom = initialZoom;
      
      // Carregar URL
      if (config.url) {
        console.log('[FloatingWindow] Setting webview src to:', config.url);
        webview.src = config.url;
        addressBar.value = config.url;
      }
      
      if (config.shortcutScript) {
        shortcutScript = config.shortcutScript;
        console.log('[FloatingWindow] ShortcutScript recebido, tamanho:', shortcutScript.length);
        
        // Se webview já carregou, injetar agora
        if (webviewReady && shortcutScript) {
          console.log('[FloatingWindow] Webview já carregou, injetando atalhos agora');
          injectShortcuts();
        }
      }
    }
    
    // Também tentar aplicar quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[FloatingWindow] DOM ready');
      if (pendingConfig && !isInitialized) {
        applyConfig();
      }
      
      // Configurar controles de janela
      const btnMinimize = document.getElementById('btn-minimize');
      const btnMaximize = document.getElementById('btn-maximize');
      const btnClose = document.getElementById('btn-close');
      
      btnMinimize.addEventListener('click', () => {
        window.floatingAPI.minimizeWindow();
      });
      
      btnMaximize.addEventListener('click', async () => {
        const result = await window.floatingAPI.maximizeWindow();
        if (result && result.isMaximized !== undefined) {
          isMaximized = result.isMaximized;
          updateMaximizeButton();
        }
      });
      
      btnClose.addEventListener('click', () => {
        window.floatingAPI.closeWindow();
      });
    });
    
    const webview = document.getElementById('webview');
    const addressBar = document.getElementById('address-bar');
    const zoomValue = document.getElementById('zoom-value');
    const tabName = document.getElementById('tab-name');
    const loading = document.getElementById('loading');
    const toolbar = document.getElementById('toolbar');
    const btnBack = document.getElementById('btn-back');
    const btnForward = document.getElementById('btn-forward');
    const btnReload = document.getElementById('btn-reload');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnZoomReset = document.getElementById('btn-zoom-reset');
    const btnDownload = document.getElementById('btn-download');
    const btnToggleToolbar = document.getElementById('btn-toggle-toolbar');
    
    // Toggle toolbar
    function updateToggleButton() {
      if (btnToggleToolbar) {
        btnToggleToolbar.innerHTML = toolbarCollapsed ? chevronDownIcon : chevronUpIcon;
        btnToggleToolbar.title = toolbarCollapsed ? 'Mostrar barra' : 'Ocultar barra';
      }
    }
    
    btnToggleToolbar.addEventListener('click', () => {
      toolbarCollapsed = !toolbarCollapsed;
      toolbar.classList.toggle('collapsed', toolbarCollapsed);
      updateToggleButton();
    });
    
    // Quando o webview começar a carregar - só mostrar loading na primeira vez
    webview.addEventListener('did-start-loading', () => {
      if (!initialLoadComplete) {
        loading.classList.remove('hidden');
      }
    });
    
    // Atualizar URL na barra de endereços
    webview.addEventListener('did-navigate', () => {
      addressBar.value = webview.getURL();
      updateNavButtons();
    });
    
    webview.addEventListener('did-navigate-in-page', () => {
      addressBar.value = webview.getURL();
      updateNavButtons();
    });
    
    webview.addEventListener('did-finish-load', () => {
      // Esconder loading e marcar como completo
      loading.classList.add('hidden');
      initialLoadComplete = true;
      webviewReady = true;
      
      addressBar.value = webview.getURL();
      updateNavButtons();
      updateZoom();
      
      // Injetar apenas se temos o script
      if (shortcutScript) {
        console.log('[FloatingWindow] did-finish-load: injetando atalhos');
        injectShortcuts();
      } else {
        console.log('[FloatingWindow] did-finish-load: shortcutScript ainda não disponível, aguardando...');
      }
    });
    
    webview.addEventListener('did-fail-load', (e) => {
      loading.classList.add('hidden');
      initialLoadComplete = true; // Marcar como completo mesmo em erro
      console.error('[FloatingWindow] Failed to load:', e.errorDescription);
    });
    
    // Handler de permissões - habilitar notificações e outras permissões
    webview.addEventListener('permissionrequest', (e) => {
      console.log('[FloatingWindow] Permission requested:', e.permission);
      
      // Lista de permissões permitidas automaticamente
      const allowedPermissions = ['notifications', 'media', 'geolocation', 'pointerLock', 'fullscreen'];
      
      if (allowedPermissions.includes(e.permission)) {
        e.request.allow();
        console.log('[FloatingWindow] Permission granted:', e.permission);
      } else {
        console.log('[FloatingWindow] Permission not in allowed list:', e.permission);
      }
    });
    
    // Injetar script de atalhos
    function injectShortcuts() {
      if (!shortcutScript) {
        console.log('[FloatingWindow] injectShortcuts chamado sem script disponível');
        return;
      }
      
      console.log('[FloatingWindow] Injetando atalhos, script tem', shortcutScript.length, 'caracteres');
      
      webview.executeJavaScript(shortcutScript)
        .then(() => console.log('[FloatingWindow] Shortcuts injected successfully'))
        .catch(err => console.error('[FloatingWindow] Error injecting shortcuts:', err));
    }
    
    // Atualizar estado dos botões de navegação
    function updateNavButtons() {
      btnBack.disabled = !webview.canGoBack();
      btnForward.disabled = !webview.canGoForward();
    }
    
    // Navegação
    btnBack.addEventListener('click', () => {
      if (webview.canGoBack()) webview.goBack();
    });
    
    btnForward.addEventListener('click', () => {
      if (webview.canGoForward()) webview.goForward();
    });
    
    btnReload.addEventListener('click', () => {
      webview.reload();
    });
    
    // Navegação por URL
    function navigateToUrl(url) {
      let finalUrl = url.trim();
      if (!finalUrl) return;
      
      // Adicionar protocolo se não tiver
      if (!finalUrl.match(/^https?:\/\//i)) {
        // Verificar se parece uma URL válida
        if (finalUrl.includes('.') && !finalUrl.includes(' ')) {
          finalUrl = 'https://' + finalUrl;
        } else {
          // Tratar como busca no Google
          finalUrl = 'https://www.google.com/search?q=' + encodeURIComponent(finalUrl);
        }
      }
      
      webview.src = finalUrl;
    }
    
    addressBar.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        navigateToUrl(addressBar.value);
        addressBar.blur();
      } else if (e.key === 'Escape') {
        addressBar.value = webview.getURL() || '';
        addressBar.blur();
      }
    });
    
    addressBar.addEventListener('focus', () => {
      addressBar.select();
    });
    
    // Zoom
    function updateZoom() {
      webview.setZoomFactor(currentZoom / 100);
      zoomValue.textContent = currentZoom + '%';
      // Notificar main process sobre mudança de zoom
      window.floatingAPI.zoomChanged(currentZoom);
    }
    
    btnZoomIn.addEventListener('click', () => {
      currentZoom = Math.min(200, currentZoom + 2);
      updateZoom();
    });
    
    btnZoomOut.addEventListener('click', () => {
      currentZoom = Math.max(25, currentZoom - 2);
      updateZoom();
    });
    
    btnZoomReset.addEventListener('click', () => {
      currentZoom = initialZoom;
      updateZoom();
    });
    
    btnDownload.addEventListener('click', () => {
      const currentUrl = webview.getURL();
      if (currentUrl) {
        window.floatingAPI.openExternal(currentUrl);
      }
    });
    
    // Teclas de atalho
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === '=' || e.key === '+') {
          e.preventDefault();
          currentZoom = Math.min(200, currentZoom + 2);
          updateZoom();
        } else if (e.key === '-') {
          e.preventDefault();
          currentZoom = Math.max(25, currentZoom - 2);
          updateZoom();
        } else if (e.key === '0') {
          e.preventDefault();
          currentZoom = initialZoom;
          updateZoom();
        } else if (e.key === 'r') {
          e.preventDefault();
          webview.reload();
        }
      }
    });
    
    // Abrir links externos no navegador padrão
    webview.addEventListener('new-window', (e) => {
      e.preventDefault();
      window.floatingAPI.openExternal(e.url);
    });
  </script>
</body>
</html>
