<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GerenciaZap</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: hsl(180, 100%, 2%);
    }
    
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: hsl(180, 100%, 6%);
      border-bottom: 1px solid hsl(180, 100%, 12%);
      -webkit-app-region: drag;
    }
    
    #toolbar button,
    #toolbar input,
    #tab-name {
      -webkit-app-region: no-drag;
    }
    
    #tab-name {
      font-size: 13px;
      font-weight: 500;
      color: hsl(180, 100%, 80%);
      padding: 0 8px;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .separator {
      width: 1px;
      height: 20px;
      background: hsl(180, 100%, 20%);
      margin: 0 4px;
    }
    
    .nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: hsl(180, 100%, 12%);
      color: hsl(180, 100%, 70%);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      font-size: 14px;
    }
    
    .nav-btn:hover {
      background: hsl(180, 100%, 18%);
      color: hsl(180, 100%, 90%);
    }
    
    .nav-btn:active {
      background: hsl(180, 100%, 22%);
    }
    
    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    #address-bar {
      flex: 1;
      height: 28px;
      padding: 0 12px;
      border: 1px solid hsl(180, 100%, 20%);
      border-radius: 14px;
      background: hsl(180, 100%, 4%);
      color: hsl(180, 100%, 60%);
      font-size: 12px;
      outline: none;
      transition: border-color 0.15s ease;
    }
    
    #address-bar:focus {
      border-color: hsl(180, 100%, 32%);
      color: hsl(180, 100%, 80%);
    }
    
    .zoom-control {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 8px;
      border-left: 1px solid hsl(180, 100%, 20%);
      margin-left: 4px;
    }
    
    #zoom-value {
      font-size: 11px;
      color: hsl(180, 100%, 50%);
      min-width: 36px;
      text-align: center;
    }
    
    #webview {
      flex: 1;
      border: none;
      background: #fff;
    }
    
    /* Loading state */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: hsl(180, 100%, 50%);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid hsl(180, 100%, 20%);
      border-top-color: hsl(180, 100%, 50%);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #loading.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="toolbar">
      <span id="tab-name">Carregando...</span>
      <div class="separator"></div>
      <button class="nav-btn" id="btn-back" title="Voltar" disabled>&#8592;</button>
      <button class="nav-btn" id="btn-forward" title="Avançar" disabled>&#8594;</button>
      <button class="nav-btn" id="btn-reload" title="Recarregar">&#8635;</button>
      
      <input type="text" id="address-bar" placeholder="Digite a URL e pressione Enter" spellcheck="false" />
      
      <div class="zoom-control">
        <button class="nav-btn" id="btn-zoom-out" title="Diminuir zoom">&#8722;</button>
        <span id="zoom-value">100%</span>
        <button class="nav-btn" id="btn-zoom-in" title="Aumentar zoom">&#43;</button>
        <button class="nav-btn" id="btn-zoom-reset" title="Resetar zoom">&#9675;</button>
      </div>
    </div>
    
    <div id="loading">
      <div class="spinner"></div>
      <span>Carregando página...</span>
    </div>
    
    <webview id="webview" allowpopups></webview>
  </div>
  
  <script>
    // Variáveis para armazenar config pendente
    let pendingConfig = null;
    let currentZoom = 100;
    let initialZoom = 100;
    let shortcutScript = '';
    let isInitialized = false;
    let initialLoadComplete = false; // Flag para controlar loading inicial
    
    // Registrar listener IMEDIATAMENTE antes de qualquer outra coisa
    console.log('[FloatingWindow] Registering onInit listener immediately');
    window.floatingAPI.onInit((config) => {
      console.log('[FloatingWindow] Received config:', config);
      pendingConfig = config;
      applyConfig();
    });
    
    // Função para aplicar a configuração
    function applyConfig() {
      if (!pendingConfig || isInitialized) return;
      
      const webview = document.getElementById('webview');
      const addressBar = document.getElementById('address-bar');
      const tabName = document.getElementById('tab-name');
      
      // Verificar se os elementos existem
      if (!webview || !addressBar || !tabName) {
        console.log('[FloatingWindow] DOM not ready, waiting...');
        setTimeout(applyConfig, 50);
        return;
      }
      
      console.log('[FloatingWindow] Applying config:', pendingConfig);
      isInitialized = true;
      
      const config = pendingConfig;
      
      // Definir nome da aba
      if (config.name) {
        tabName.textContent = config.name;
        document.title = config.name + ' - GerenciaZap';
      }
      
      // Definir zoom inicial
      initialZoom = config.zoom || 100;
      currentZoom = initialZoom;
      
      // Carregar URL
      if (config.url) {
        console.log('[FloatingWindow] Setting webview src to:', config.url);
        webview.src = config.url;
        addressBar.value = config.url;
      }
      
      if (config.shortcutScript) {
        shortcutScript = config.shortcutScript;
      }
    }
    
    // Também tentar aplicar quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[FloatingWindow] DOM ready');
      if (pendingConfig && !isInitialized) {
        applyConfig();
      }
    });
    
    const webview = document.getElementById('webview');
    const addressBar = document.getElementById('address-bar');
    const zoomValue = document.getElementById('zoom-value');
    const tabName = document.getElementById('tab-name');
    const loading = document.getElementById('loading');
    const btnBack = document.getElementById('btn-back');
    const btnForward = document.getElementById('btn-forward');
    const btnReload = document.getElementById('btn-reload');
    const btnZoomIn = document.getElementById('btn-zoom-in');
    const btnZoomOut = document.getElementById('btn-zoom-out');
    const btnZoomReset = document.getElementById('btn-zoom-reset');
    
    // Quando o webview começar a carregar - só mostrar loading na primeira vez
    webview.addEventListener('did-start-loading', () => {
      if (!initialLoadComplete) {
        loading.classList.remove('hidden');
      }
    });
    
    // Atualizar URL na barra de endereços
    webview.addEventListener('did-navigate', () => {
      addressBar.value = webview.getURL();
      updateNavButtons();
    });
    
    webview.addEventListener('did-navigate-in-page', () => {
      addressBar.value = webview.getURL();
      updateNavButtons();
    });
    
    webview.addEventListener('did-finish-load', () => {
      // Esconder loading e marcar como completo
      loading.classList.add('hidden');
      initialLoadComplete = true;
      
      addressBar.value = webview.getURL();
      updateNavButtons();
      updateZoom();
      injectShortcuts();
    });
    
    webview.addEventListener('did-fail-load', (e) => {
      loading.classList.add('hidden');
      initialLoadComplete = true; // Marcar como completo mesmo em erro
      console.error('[FloatingWindow] Failed to load:', e.errorDescription);
    });
    
    // Injetar script de atalhos
    function injectShortcuts() {
      if (shortcutScript) {
        webview.executeJavaScript(shortcutScript)
          .then(() => console.log('[FloatingWindow] Shortcuts injected'))
          .catch(err => console.error('[FloatingWindow] Error injecting shortcuts:', err));
      }
    }
    
    // Atualizar estado dos botões de navegação
    function updateNavButtons() {
      btnBack.disabled = !webview.canGoBack();
      btnForward.disabled = !webview.canGoForward();
    }
    
    // Navegação
    btnBack.addEventListener('click', () => {
      if (webview.canGoBack()) webview.goBack();
    });
    
    btnForward.addEventListener('click', () => {
      if (webview.canGoForward()) webview.goForward();
    });
    
    btnReload.addEventListener('click', () => {
      webview.reload();
    });
    
    // Navegação por URL
    function navigateToUrl(url) {
      let finalUrl = url.trim();
      if (!finalUrl) return;
      
      // Adicionar protocolo se não tiver
      if (!finalUrl.match(/^https?:\/\//i)) {
        // Verificar se parece uma URL válida
        if (finalUrl.includes('.') && !finalUrl.includes(' ')) {
          finalUrl = 'https://' + finalUrl;
        } else {
          // Tratar como busca no Google
          finalUrl = 'https://www.google.com/search?q=' + encodeURIComponent(finalUrl);
        }
      }
      
      webview.src = finalUrl;
    }
    
    addressBar.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        navigateToUrl(addressBar.value);
        addressBar.blur();
      } else if (e.key === 'Escape') {
        addressBar.value = webview.getURL() || '';
        addressBar.blur();
      }
    });
    
    addressBar.addEventListener('focus', () => {
      addressBar.select();
    });
    
    // Zoom
    function updateZoom() {
      webview.setZoomFactor(currentZoom / 100);
      zoomValue.textContent = currentZoom + '%';
      // Notificar main process sobre mudança de zoom
      window.floatingAPI.zoomChanged(currentZoom);
    }
    
    btnZoomIn.addEventListener('click', () => {
      currentZoom = Math.min(200, currentZoom + 10);
      updateZoom();
    });
    
    btnZoomOut.addEventListener('click', () => {
      currentZoom = Math.max(25, currentZoom - 10);
      updateZoom();
    });
    
    btnZoomReset.addEventListener('click', () => {
      currentZoom = initialZoom;
      updateZoom();
    });
    
    // Teclas de atalho
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === '=' || e.key === '+') {
          e.preventDefault();
          currentZoom = Math.min(200, currentZoom + 10);
          updateZoom();
        } else if (e.key === '-') {
          e.preventDefault();
          currentZoom = Math.max(25, currentZoom - 10);
          updateZoom();
        } else if (e.key === '0') {
          e.preventDefault();
          currentZoom = initialZoom;
          updateZoom();
        } else if (e.key === 'r') {
          e.preventDefault();
          webview.reload();
        }
      }
    });
    
    // Abrir links externos no navegador padrão
    webview.addEventListener('new-window', (e) => {
      e.preventDefault();
      window.floatingAPI.openExternal(e.url);
    });
  </script>
</body>
</html>
